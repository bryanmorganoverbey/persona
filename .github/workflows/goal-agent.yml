name: Goal Agent â€” Execute Vision Board Tasks

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Month to process (01-12). Defaults to 03.'
        required: false
        default: '03'
        type: string
      max_tasks:
        description: 'Max tasks to execute per run'
        required: false
        default: '1'
        type: string

# Requires "Read and write permissions" enabled in repo Settings > Actions > General > Workflow permissions.
# If push still fails with 403, create a Personal Access Token with repo scope,
# store it as a secret named PERSONA_PAT, and use it in the checkout step:
#   token: ${{ secrets.PERSONA_PAT }}
permissions:
  contents: write

concurrency:
  group: goal-agent
  cancel-in-progress: false

jobs:
  execute-goals:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GOAL_AGENT_MAX_TASKS: ${{ github.event.inputs.max_tasks || '1' }}
      GOAL_AGENT_MAX_BUDGET_USD: '5.0'
      GOAL_AGENT_MODEL: 'claude-sonnet-4-6'
      GOAL_AGENT_MAX_CALLS_PER_MIN: '5'
      GOAL_AGENT_MAX_TOKENS_PER_MIN: '10000'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r scripts/goal-agent/requirements.txt

      - name: Run goal agent
        working-directory: ${{ github.workspace }}
        run: |
          MONTH_ARG="${{ github.event.inputs.month || '03' }}"
          python scripts/goal-agent/main.py "${{ github.workspace }}" $MONTH_ARG
